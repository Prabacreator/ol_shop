<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>pr@BaDB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
  *,body{
    font-family:var(--bs-font-sans-serif)!important;
    font-weight:300!important;
  }    
  .container{
    display:flex;
    width:100%;
    min-height:100vh;
    justify-content:center;
    align-items:center;
    text-align:center;
    position:relative;
  }  
   /* Video background */
  video.bg-video{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    z-index:-2;
  }
  .overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    z-index:-1;
  }
  /* Glass effect modal */
  .card, .modal.glass .modal-content{
    background:rgba(255,255,255,.018);
    backdrop-filter: blur(.5px);
    -webkit-backdrop-filter: blur(14px);
    border:0;
    color:#fff;
    box-shadow:0 8px 32px rgba(0,0,0,.4);
  }
  .modal.glass .modal-header,
  .modal.glass .modal-footer{
      border:0;
  }
  .modal.glass .btn-close{
    filter:invert(1);
  }
  .modal.glass input,
  .modal.glass textarea{
    background:rgba(255,255,255,.25);
    border:1px solid rgba(255,255,255,.3);
    color:#fff;
  }
  .modal.glass input::placeholder,
  .modal.glass textarea::placeholder{
    color:#eee;
  }
  .modal-img{
    width:140px;
    height:140px;
    border-radius:50%;
    object-fit:cover;
    display:block;
    margin:auto;
    cursor:pointer;
  }  
  .pointer{ 
    cursor:pointer;
    object-fit: cover;
  }  
  .card-img{
    width:200px;
    
    display:block;
    cursor:pointer;
    object-fit:cover;
    margin-bottom: .25rem;
  }  
  .invoice.img{
    width:auto;
    object-fit:cover;
    display:block;
    margin:auto;
    cursor:pointer;
  }
  input,textarea{
    width:100%;
    padding:.15rem .55rem;
    font-size:.875rem;
    border:1px solid #ced4da;
    border-radius:.25rem;
    outline:none;
  }  
  input[type=number]{
    text-align:center;
    font-size:1rem;
    border-radius:25px;
  }  
  .btn, .badge{padding:.15rem .55rem !important;}
    
  /* sweetalert */    
  .swal2-popup{
    padding:1.5rem;
    border-radius:1rem;
    font-family:var(--bs-font-sans-serif)!important;
    box-shadow:0 0.125rem 0.25rem rgba(0,0,0,.075);
  }    
  .swal2-title{
    font-size:1rem;
    font-weight:500 !important;
  }    
  .swal2-text{
    font-size:.75rem;
    font-weight:300 !important;
  }    
  .swal2-html-container{
    font-size:1rem;
    color:#212529 !important;
  }    
  .swal2-confirm{
    font-weight:350!important;
    color:#f8f9fa;
    background:#198754;
    padding:.15rem 1.25rem;
    border-radius:25px;
  }    
  .swal2-cancel{
    color:#212529;
    background:#a3cfbb;
    border-radius:25px;
    padding:.15rem 1.25rem;
    font-weight:350 !important;
  }    
  .swal2-icon{
    color:#198754!important;
    border-color:#198754!important;
    margin-top:.5rem;
    background:#f8f9fa;
  }    
    
  /* table cart */  
  .tableOrder th,td,.row{
    font-family: var(--bs-font-monospace)!important;
  }
  .tableOrder{
    width:100%;
    border-collapse:collapse;
    font-size:.75rem!important;
    text-align:center;
  }  
  .tableOrder th,td{
    white-space:nowrap;
    vertical-align:middle;
    padding:.25rem;
  }  
  .tableOrder thead th{
    color:#fff;
    border:.25px solid #fff;
    background:#198754;
  }  
  .tableOrder tbody tr:hover{
    font-weight:bold;
    background:#ccc;
  }  
  .tableOrder tbody tr{
    border-bottom:.25px solid #ccc;
  }  
  .tableOrder tbody td:nth-child(4),  
  .tableOrder tbody td:nth-child(5){
    text-align:right;
  }  
  .tableOrder tbody td:nth-child(2){
    text-align:left;
    white-space:normal;
  }  
  .tableOrder tfoot th{
    text-align:right;
    padding-top:.55rem;
  }  
  .tableOrder tfoot th:nth-child(2){
    color:#dc3545;
    text-align:right;
    padding-top:.55rem;
  }  
  .position-relative{
    width:100%;
    display:flex;
    justify-content:center;
    padding: .15rem .15rem;
  }
  </style>
</head>
<body class="text-bg-dark" onclick="home.classList.toggle('d-none')">

<!-- BACKGROUND VIDEO -->


<!-- CONTENT -->
<div id="home" class="container-fluid min-vh-100 d-flex justify-content-center align-items-center text-center">
  <div class="card shadow">
    <div class="card-header">
      <h5 class="fw-bolder">Kedai Praba</h5>
    </div>
    <div class="card-body">
      <p class="fw-light">
        Sedia kebutuhan sembako dan kebutuhan lainnya dgn harga terjangkau.
      </p>
      <button type="button" class="btn btn-sm btn-outline-light w-50" onclick="m.show('#pageProduct');home.classList.toggle('d-none')">
        Mulai Belanja
      </button>
    </div>
  </div>
</div>

<!-- PAGE PRODUCT -->
<div id="pageProduct" class="modal fade glass" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content h-100">
      <div class="modal-header">
        <span id="delUser">Logout</span>
        <span class="btn-close" onclick="m.hide('#pageProduct')"></span>
      </div>
      <div id="loadProduct" class="modal-body"></div>
      <div class="modal-footer flex-column">
        <div id="tableOrder" class="table-responsive mb-3 w-100 text-bg-light"></div>
        <div class="d-flex justify-content-center gap-2">
          <button id="btnInv" class="btn btn-outline-light" onclick="loadInvoice();m.hide('#pageProduct');m.show('#invoice')">Invoice</button>
          <button class="btn btn-outline-light d-none" id="btnAddProduct"
            onclick="m.hide('#pageProduct');m.show('#formProduct')">Tambah Produk</button>
          <button class="btn btn-outline-light " id="enter">Kirim Order</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FORM PRODUCT -->
<div id="formProduct" class="modal fade glass" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="fw-bolder">INPUT PRODUCT</h5>
        <span class="btn-close" data-bs-dismiss="modal" onclick="m.show('#pageProduct')"></span>
      </div>
      <div class="modal-body px-3">
        <img id="vew" class="modal-img mb-2 d-none pointer" onclick="pic.click()">
        <div class="d-flex justify-content-center mb-2">
          <input id="pic" type="file" accept="image/*" hidden onchange="viewPicture(this)">
          <button type="button" class="btn btn-sm btn-outline-light" onclick="pic.click()">Pilih Gambar</button>
        </div>

        <label>Nama Produk</label>
        <textarea id="pdc"></textarea>

        <div class="d-flex justify-content-between my-1">
          <div class="mx-1">
            <label>Harga</label>
            <input type="number" id="prc" min="1">
          </div>
          <div class="mx-1">
            <label>Stock</label>
            <input type="number" id="stk" min="0">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-sm bg-primary-subtle" onclick="resetForm()">Reset</button>
        <button class="btn btn-sm btn-danger d-none" id="del">Hapus</button>
        <button class="btn btn-sm btn-primary" onclick="saveProduct()">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- INVOICE -->
<div id="invoice" class="modal fade glass" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="fw-bolder">TRANSAKSI</h5>
        <span class="btn-close" data-bs-dismiss="modal" onclick="m.show('#pageProduct')"></span>
      </div>
      <div id="loadInvoice" class="modal-body text-center"></div>
    </div>
  </div>
</div>

<!-- FORM USER -->
<div id="formUser" class="modal fade glass" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered px-3">
    <div class="modal-content">
      <div class="modal-header justify-content-center">
        <h5 class="fw-bolder">Register</h5>
        <span class="btn-close" data-bs-dismiss="modal" onclick="m.show('#pageProduct')"></span>
      </div>
      <div class="modal-body px-3">
        <div class="row">
          <div class="col-4"><label>üë® Nama</label></div>
          <div class="col-8"><input type="text" id="username"></div>
        </div>
        <div class="row my-1">
          <div class="col-4"><label>‚òéÔ∏è Phone</label></div>
          <div class="col-8"><input type="tel" id="telphone"></div>
        </div>
        <label>üè† Alamat</label>
        <textarea id="address"></textarea>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn bg-success-subtle px-3" id="addUser">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- JAVA SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
/* =========================
   == DB ==
========================= */
let db=null;
const openDB=()=>new Promise((res,rej)=>{
  const req=indexedDB.open('pr@Ba',3);
  req.onupgradeneeded=e=>{
    db=e.target.result;
    ['product','order','invoice'].forEach(s=>{
      if(!db.objectStoreNames.contains(s))
        db.createObjectStore(s,{keyPath:'id',autoIncrement:true});
    });
  };
  req.onsuccess=e=>res(db=e.target.result);
  req.onerror=e=>rej(e);
});

const add=(s,d)=>new Promise((res,rej)=>{
  const r=db.transaction(s,'readwrite').objectStore(s).add(d);
  r.onsuccess=()=>res(d); r.onerror=e=>rej(e);
});
const put=(s,d)=>new Promise((res,rej)=>{
  const r=db.transaction(s,'readwrite').objectStore(s).put(d);
  r.onsuccess=()=>res(d); r.onerror=e=>rej(e);
});
const del=(s,id)=>new Promise((res,rej)=>{
  const r=db.transaction(s,'readwrite').objectStore(s).delete(id);
  r.onsuccess=()=>res(); r.onerror=e=>rej(e);
});
const clear=s=>new Promise((res,rej)=>{
  const r=db.transaction(s,'readwrite').objectStore(s).clear();
  r.onsuccess=()=>res(); r.onerror=e=>rej(e);
});
const gets=s=>new Promise((res,rej)=>{
  const data=[];
  const r=db.transaction(s).objectStore(s).openCursor();
  r.onsuccess=e=>{
    const c=e.target.result;
    c?(data.push({...c.value,id:c.key}),c.continue()):res(data);
  };
  r.onerror=e=>rej(e);
});

/* =========================
   == SESSION ==
========================= */
const setSession=d=>localStorage.setItem('session',JSON.stringify(d));
const getSession=()=>JSON.parse(localStorage.getItem('session')||'null');
const delSession=()=>localStorage.removeItem('session');

/* =========================
   == UI HELPERS ==
========================= */
const m={
  get(el){
    if(typeof el==='string')
      el=document.querySelector(/^[.#]/.test(el)?el:`#${el}`);
    return el?bootstrap.Modal.getOrCreateInstance(el):null;
  },
  show(el){this.get(el)?.show()},
  hide(el){this.get(el)?.hide()}
};
const $=i=>document.getElementById(i);
const rp=n=>Number(n||0).toLocaleString('id-ID');
const times = new Date().toLocaleString('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'})+'  ‚è∞ ['+new Date().toLocaleString('id-ID',{hour:'numeric',minute:'numeric'})+']';
const setUpper=el=> el.value=el.value.replace(/\b\w/g,c=>c.toUpperCase());
const setPhone=el=>{
  let v=el.value.replace(/\D/g,'').slice(0,12);
  if(v.length>8) v=v.replace(/(\d{4})(\d{4})(\d+)/,'$1-$2-$3');
  else if(v.length>4) v=v.replace(/(\d{4})(\d+)/,'$1-$2');
  el.value=v;
};

document.querySelectorAll('input[type="text"],textarea')
  .forEach(el=>el.oninput=()=>setUpper(el));
document.querySelectorAll('input[type="tel"]')
  .forEach(el=>el.oninput=()=>setPhone(el));
document.querySelectorAll('input,textarea')
  .forEach(el=>el.onclick=()=>el.value='');

const showLoading=()=>Swal.fire({title:'Loading...',allowOutsideClick:false,showConfirmButton:false,didOpen:()=>Swal.showLoading()});
const hideLoading=()=>Swal.close();
const ok=t=>Swal.fire({icon:'success',text:t,showConfirmButton:false,timer:1200});
const err=t=>Swal.fire({icon:'info',text:t,showConfirmButton:false,timer:1200});

/* =========================
   == BLOB HELPERS ==
========================= */
const blobToURL = b => b ? URL.createObjectURL(b) : '';
const revokeURL = url => URL.revokeObjectURL(url);

/* =========================
   == STATE ==
========================= */
let stream=null;
let imgData = null;
let editId  = null;

/* =========================
   == USER / AUTH ==
========================= */
const home = $('home');
const btnAddUser = $('addUser');
const btnDelUser = $('delUser');
const user = $('username');
const telp = $('telphone');
const addr = $('address');

btnAddUser.onclick = async ()=>{
  const u = user.value.trim();
  const t = telp.value.trim();
  const a = addr.value.trim();

  if(!u || !t || !a) return err('Silakan isi data dg lengkap');

  const inv = await getInvoice();
  const exist = inv.some(v => v.telphone === t);

  if(exist){
    const c = await Swal.fire({
      icon:'warning',
      title:'Data sudah ada',
      text:'Nomor ini sudah pernah transaksi. Lanjutkan login?',
      showCancelButton:true,
      confirmButtonText:'Lanjutkan',
      cancelButtonText:'Batal'
    });
    if(!c.isConfirmed) return;
  }

  const role = u.toLowerCase()==='admin' ? 'admin' : 'user';
  setSession({role,user:u,telp:t,addr:a});

  ok(`Login sebagai ${role.toUpperCase()}`);
  m.hide('#formUser');
  m.show('#pageProduct');
  applyRole();
  loadProduct();
  tableOrder();
};
btnDelUser.onclick = async ()=>{
  const s = getSession();
  if(!s){
    m.hide('#pageProduct');
    m.show('#formUser');
    return;
  }else{
    delSession();
    location.reload();
  }
};

/* =========================
   == ELEMENT ==
========================= */
const pdc  = $('pdc');
const prc  = $('prc');
const stk  = $('stk');
const pic  = $('pic');
const vew  = $('vew');
const dels = $('del');
const enter= $('enter');
const table= $('tableOrder');
const btnAddProduct = $('btnAddProduct');
const btnInv= $('btnInv');

/* =========================
   == API ==
========================= */
const getProduct = () => gets('product');
const addProduct = dt => add('product', dt);
const setProduct = dt => put('product', dt);
const delProduct = id => del('product', id);

const getOrder = () => gets('order');
const addOrder = dt => add('order', dt);
const setOrder = dt => put('order', dt);
const delOrder = id => del('order', id);
const removeAll = () => clear('order');

const getInvoice = () => gets('invoice');
const addInvoice = dt => add('invoice', dt);
const delInvoice = id => del('invoice', id);

/* =========================
   == ROLE APPLY ==
========================= */
function applyRole(){
  const s = getSession();
  const isAdmin = s?.role === 'admin';

  btnAddProduct.classList.toggle('d-none', !isAdmin);

  if(isAdmin){
    enter.classList.add('d-none');
    table.innerHTML = '';
  }
}

/* =========================
   == IMAGE PREVIEW ==
========================= */
function viewPicture(input){
  const f = input.files[0];
  if(!f) return;
  imgData = f; // simpan blob langsung
  const url = blobToURL(f);
  vew.src = url;
  vew.onload = ()=> revokeURL(url);
  vew.classList.remove('d-none');
}

/* =========================
   == SAVE PRODUCT (ADMIN ONLY) ==
========================= */
async function saveProduct(){
  const s = getSession();
  if(s?.role!=='admin') return err('Akses ditolak');

  const name  = pdc.value.trim();
  const price = +prc.value;
  const stock = +stk.value;

  if(!name || price<=0 || stock<0) return err('Data belum lengkap');

  const data = {
    pdc: name,
    prc: price,
    stk: stock,
    img: imgData || null // blob
  };

  if(editId){
    data.id = editId;
    await setProduct(data);
    ok('Produk diperbarui');
  }else{
    await addProduct(data);
    ok('Produk ditambahkan');
  }

  resetForm();
  loadProduct();
  m.hide('#formProduct');
  m.show('#pageProduct');
}

/* =========================
   == RESET FORM ==
========================= */
function resetForm(){
  editId = null;
  imgData = null;
  pdc.value = prc.value = stk.value = '';
  pic.value = '';
  vew.src = '';
  vew.classList.add('d-none');
  dels.classList.add('d-none');
}

/* =========================
   == LOAD PRODUCT ==
========================= */
async function loadProduct(){
  const el = $('loadProduct');
  if(!el) return;

  const product = await getProduct();
  const s = getSession();
  const isAdmin = s?.role === 'admin';

  if(!product.length){
    el.innerHTML = `<div class="alert alert-warning text-center">Produk belum tersedia</div>`;
    return;
  }

  el.innerHTML = product.map(p=>{
    const url = p.img ? blobToURL(p.img) : '';
    return `
    <div class="d-flex justify-content-between align-items-center my-2 p-2 rounded">
      <img src="${url}" onload="revokeURL('${url}')" style="object-fit:cover;width:120px;height:90px;border-radius:.5rem"/>
      <div class="d-flex flex-column text-center text-white text-dark w-50">
        <p class="fw-bolder m-0">${p.pdc}</p>
        <p class="m-0">Harga: Rp ${rp(p.prc)}</p>
        <p class="m-0">Stock: ${p.stk}</p>
        <div class="d-flex justify-content-around">
          <span class="badge ${isAdmin?'':'d-none'} ${p.stk<=0?'bg-danger':'bg-warning'} pointer"
                onclick="editProduct(${p.id})">
            ${p.stk<=0?'Stock Habis':'Update'}
          </span>
          ${!isAdmin ? `
          <span class="badge ${p.stk<=0?'bg-warning text-dark':'bg-success'} pointer"
                onclick="${p.stk>0?`enterOrder(${p.id})`:''}">
            ${p.stk<=0?'Product sedang disiapkan..':'Order'}
          </span>` : ``}
        </div>
      </div>
    </div>
    `;
  }).join('');
  
  btnInv.textContent= `${isAdmin ? 'Invoice' : 'Riwayat Transaksi'}`;
  btnInv.className =`${!s ? 'btn btn-outline-light d-none' : 'btn btn-outline-light'}`;
}

/* =========================
   == EDIT PRODUCT ==
========================= */
async function editProduct(id){
  const s = getSession();
  if(s?.role!=='admin') return err('Akses ditolak');

  const product = await getProduct();
  const p = product.find(x=>x.id===id);
  if(!p) return;

  editId = id;
  imgData = null;

  pdc.value = p.pdc;
  prc.value = p.prc;
  stk.value = p.stk;

  if(p.img){
    const url = blobToURL(p.img);
    vew.src = url;
    vew.onload = ()=> revokeURL(url);
    vew.classList.remove('d-none');
  }

  dels.onclick = async ()=>{
    const c = await Swal.fire({
      icon:'warning',
      text:'Hapus produk?',
      showCancelButton:true,
      confirmButtonText:'Ya'
    });
    if(!c.isConfirmed) return;

    await delProduct(id);
    ok('Produk dihapus');
    resetForm();
    m.hide('#formProduct');
    loadProduct();
  };

  dels.classList.remove('d-none');
  m.show('#formProduct');
}

/* =========================
   == INPUT ORDER ==
========================= */
async function enterOrder(id){
  const s = getSession();
  if(s?.role!=='user'){
    const c = await Swal.fire({
      icon:'warning',
      text:'Silakan isi data sebelum order !',
      showCancelButton:true
    });
    if(!c.isConfirmed) return;
    m.hide('#pageProduct');
    m.show('#formUser');
  } else {
  
  const product = await getProduct();
  const order   = await getOrder();

  const pr = product.find(x=>x.id===id);
  if(!pr || pr.stk<=0) return err('Dalam proses menyiapkan Produk');

  const or = order.find(x=>x.productId===id);

  if(or){
    if(or.qty>=pr.stk) return err('Pesanan melebihi stok!');
    or.qty++;
    await setOrder(or);
  }else{
    await addOrder({productId:id,pdc:pr.pdc,prc:pr.prc,qty:1});
  }

  ok('Masuk cart');
  loadProduct();
  tableOrder();
  }
}

/* =========================
   == TABLE ORDER ==
========================= */
async function tableOrder(){
  const s = getSession();
  if(s?.role!=='user'){
    table.innerHTML='';
    enter.classList.add('d-none');
    return;
  }

  const el = $('tableOrder');
  el.innerHTML = '';

  const order = await getOrder();
  if(!order.length){
    enter.classList.add('d-none');
    return;
  }

  let total=0,no=1;

  el.innerHTML = `
  <div class="px-2" style="font-size:.75rem">
    <div class="row">
      <div class="col-3">Nama</div>
      <div class="col-1">:</div>
      <div class="col-8 fw-bolder">${s.user}</div>
    </div>
    <div class="row">
      <div class="col-3">Phone</div>
      <div class="col-1">:</div>
      <div class="col-8 text-primary">${s.telp}</div>
    </div>
    <div class="row">
      <div class="col-3">Alamat</div>
      <div class="col-1">:</div>
      <div class="col-8">${s.addr}</div>
    </div>
  </div>
  <table class="tableOrder">
    <thead>
      <tr>
        <th rowspan="2">No</th>
        <th rowspan="2">Produk</th>
        <th rowspan="2">Jml</th>
        <th colspan="2">Harga</th>
      </tr>
      <tr>
        <th>Satuan</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      ${order.map(v=>{
        const sub=v.prc*v.qty; total+=sub;
        return `
        <tr data-id="${v.id}">
          <td>${no++}</td>
          <td>${v.pdc}</td>
          <td class="pointer fw-bolder">${v.qty}</td>
          <td>${rp(v.prc)}</td>
          <td>${rp(sub)}</td>
        </tr>`;
      }).join('')}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="3">TOTAL</th>
        <th colspan="2">Rp ${rp(total)}</th>
      </tr>
    </tfoot>
  </table>`;

  /* klik row ‚Üí edit qty / remove */
  el.querySelectorAll('tbody tr').forEach(tr=>{
    tr.onclick = async ()=>{
      const id = +tr.dataset.id;
      const order = await getOrder();
      const or = order.find(x=>x.id===id);
      if(!or) return;

      const r = await Swal.fire({
        title:or.pdc,
        text:'Pilih aksi',
        icon:'question',
        showCancelButton:true,
        confirmButtonText:'Edit Jml Product',
        cancelButtonText:'Hapus',
        reverseButtons:true
      });

      /* EDIT QTY */
      if(r.isConfirmed){
        const {value:qty} = await Swal.fire({
          title:'Ubah Jumlah Product',
          input:'number',
          inputValue:or.qty,
          inputAttributes:{min:1},
          showCancelButton:true,
          inputValidator:v=>!v||v<1?'Qty minimal 1':null
        });
        if(!qty) return;

        const product = await getProduct();
        const pr = product.find(p=>p.id===or.productId);
        if(qty>pr.stk) return err('Stock tidak cukup');

        or.qty = +qty;
        await setOrder(or);
        tableOrder();
      }

      /* DELETE */
      if(r.dismiss===Swal.DismissReason.cancel){
        const c = await Swal.fire({
          icon:'warning',
          text:'Yakin hapus item?',
          showCancelButton:true,
          confirmButtonText:'Ya, hapus'
        });
        if(!c.isConfirmed) return;
        await delOrder(id);
        tableOrder();
      }
    };
  });

  enter.classList.remove('d-none');
  enter.onclick = makeInvoice;
}

/* == CHECKOUT (USER ONLY) == */
async function makeInvoice(){
  const s = getSession();
  if(s?.role!=='user') return err('Hanya user yang dapat checkout');

  const order = await getOrder();
  if(!order.length) return err('Cart masih kosong');

  const c = await Swal.fire({
    icon:'question',
    title:'Checkout?',
    text:'Lanjutkan pesanan ini?',
    showCancelButton:true,
    confirmButtonText:'Ya'
  });
  if(!c.isConfirmed) return;

  showLoading();
  enter.classList.add('d-none');

  try{
    /* === UPDATE STOCK === */
    const product = await getProduct();
    for(const v of order){
      const p = product.find(x=>x.id===v.productId);
      if(!p) continue;
      p.stk = Math.max(0, p.stk - v.qty);
      await setProduct(p);
    }

    /* === CAPTURE ‚Üí BLOB === */
    const canvas = await html2canvas(table,{scale:1});
    const blob = await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.7));

    await addInvoice({
      timestamp: times,
      username : s.user,
      telphone : s.telp,
      address  : s.addr,
      img      : blob
    });

    await removeAll();
    table.innerHTML='';
    ok('Checkout berhasil!');
    loadProduct();
    loadInvoice();
    m.hide('#pageProduct');
    m.show('#invoice');
  }catch(e){
    err('Gagal membuat invoice');
  }finally{
    hideLoading();
  }
}

/* == LOAD INVOICE == */
async function loadInvoice(){
  const el = $('loadInvoice');
  el.innerHTML = '';

  const inv = await getInvoice();
  if(!inv.length) return;

  const s = getSession();
  const isAdmin = s?.role === 'admin';

  const data = isAdmin ? inv : inv.filter(x=>x.telphone === s?.telp);

  el.innerHTML = data.reverse().map(v=>{
    const url = blobToURL(v.img);
    return `
    <div class="card mb-2 px-1 position-relative text-bg-light">
      <div class="fw-bolder text-end mt-2 pe-2" style="font-size:.55rem">${v.timestamp}</div>
      <img src="${url}" class="img-fluid my-2 pointer w-auto" onload="revokeURL('${url}')">
      ${isAdmin ? `<span class="badge bg-danger pointer position-absolute top-0 start-0 m-1" data-id="${v.id}">Hapus</span>` : ``}
    </div>
    `;
  }).join('');

  if(isAdmin){
    el.querySelectorAll('[data-id]').forEach(b=>{
      b.onclick = async ()=>{
        const id = +b.dataset.id;
        const c = await Swal.fire({
          icon:'warning',
          text:'Hapus invoice ini?',
          showCancelButton:true
        });
        if(!c.isConfirmed) return;
        await delInvoice(id);
        ok('Invoice dihapus');
        loadInvoice();
      };
    });
  }
}

/* =========================
   == INIT ==
========================= */
(async()=>{
  await openDB();
  const s = getSession();
  btnDelUser.textContent = `${!s ? 'Login' : 'logout' }`;
  btnDelUser.className = `${!s ? 'badge pointer bg-success' : 'badge pointer bg-danger' }`; 
  home.classList.add('d-none');
  m.show('#pageProduct');
  applyRole();
  loadProduct();
  loadInvoice();
  tableOrder();
})();
</script>
</body>
</html>